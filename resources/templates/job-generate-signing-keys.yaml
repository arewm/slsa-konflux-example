{{- if .Values.signing.enableSigning }}
apiVersion: batch/v1
kind: Job
metadata:
  name: generate-release-signing-keys
  namespace: {{ .Values.release.targetNamespace }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      name: generate-release-signing-keys
    spec:
      serviceAccountName: signing-key-generator
      restartPolicy: Never
      containers:
      - name: generate-keys
        image: quay.io/konflux-ci/task-runner:1.1.1@sha256:c3b31a65d6e82a307f0f2f6eb5762548e655695949fd42735ec8f178142d6f14
        command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail

          echo "Checking if signing key secret already exists..."

          # Check if secret exists (only skip if regenerateKeys is false)
          {{- if not .Values.signing.regenerateKeys }}
          if kubectl get secret {{ .Values.signing.signingSecretName }} -n {{ .Values.release.targetNamespace }} >/dev/null 2>&1; then
            echo "Secret {{ .Values.signing.signingSecretName }} already exists and regenerateKeys is false. Skipping generation."
            exit 0
          fi
          {{- end }}

          echo "Generating cosign key-pair for release signing..."

          # Use /tmp for key generation (writable directory)
          cd /tmp

          # Generate keys without password (suitable for demo)
          # For production, keys should be encrypted and password provided via separate secret
          export COSIGN_PASSWORD=""
          cosign generate-key-pair

          if [[ ! -f "cosign.key" ]] || [[ ! -f "cosign.pub" ]]; then
            echo "ERROR: Failed to generate cosign key-pair"
            exit 1
          fi

          echo "Key-pair generated successfully!"
          echo ""
          echo "Public key:"
          cat cosign.pub
          echo ""

          # Delete existing secret if it exists
          kubectl delete secret {{ .Values.signing.signingSecretName }} \
            -n {{ .Values.release.targetNamespace }} \
            --ignore-not-found=true

          # Create secret from generated keys
          kubectl create secret generic {{ .Values.signing.signingSecretName }} \
            --from-file=cosign.key=/tmp/cosign.key \
            --from-file=cosign.pub=/tmp/cosign.pub \
            --namespace={{ .Values.release.targetNamespace }}

          echo "Secret {{ .Values.signing.signingSecretName }} created successfully!"
          echo ""
          echo "To retrieve the public key:"
          echo "  kubectl get secret {{ .Values.signing.signingSecretName }} -n {{ .Values.release.targetNamespace }} -o jsonpath='{.data.cosign\.pub}' | base64 -d"
          echo ""
          echo "To use in Tekton tasks:"
          echo "  - name: VSA_SIGNING_KEY"
          echo "    value: \"k8s://{{ .Values.release.targetNamespace }}/{{ .Values.signing.signingSecretName }}\""
{{- end }}
