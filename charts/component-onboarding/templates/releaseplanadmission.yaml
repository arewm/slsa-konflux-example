{{- $destination := .Values.release.destination | default (printf "registry-service.kind-registry/released-%s" .Values.applicationName) }}
{{- $pipelineUrl := .Values.release.pipeline.url | default .Values.repositoryUrl }}
{{- $ociStorage := .Values.release.trustedArtifacts.ociStorage }}
apiVersion: appstudio.redhat.com/v1alpha1
kind: ReleasePlanAdmission
metadata:
  name: {{ .Values.applicationName }}-release-admission
  namespace: {{ .Values.release.targetNamespace }}
spec:
  applications:
    - {{ .Values.applicationName }}
  origin: {{ .Values.namespace }}
  environment: {{ .Values.release.environment }}
  policy: {{ .Values.release.policyName }}
  pipeline:
    serviceAccountName: {{ .Values.release.serviceAccount }}
    pipelineRef:
      resolver: git
      params:
        - name: url
          value: {{ $pipelineUrl }}
        - name: revision
          value: {{ .Values.release.pipeline.revision }}
        - name: pathInRepo
          value: {{ .Values.release.pipeline.pathInRepo }}
      ociStorage: {{ $ociStorage }}
    taskRunSpecs:
      - pipelineTaskName: verify-conforma
        computeResources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 512Mi
      - pipelineTaskName: verify-access-to-resources
        computeResources:
          requests:
            cpu: 100m
            memory: 100Mi
          limits:
            cpu: 500m
            memory: 256Mi
      - pipelineTaskName: push-snapshot
        computeResources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 512Mi
      - pipelineTaskName: apply-mapping
        computeResources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            memory: 256Mi
      - pipelineTaskName: collect-data
        computeResources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            memory: 256Mi
      - pipelineTaskName: reduce-snapshot
        computeResources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            memory: 256Mi
  data:
    mapping:
      defaults:
        pushSourceContainer: false
      components:
        - name: {{ .Values.applicationName }}
          repository: {{ $destination }}
          tags:
            - latest
            - "{{ "{{" }} git_sha {{ "}}" }}"
