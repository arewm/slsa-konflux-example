---
# Attach VSA attestations to pushed container images
# This task retrieves VSA files from trusted artifacts and attaches them
# as attestations to the destination container images after they've been pushed

apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: attach-vsa
  annotations:
    tekton.dev/displayName: Attach VSA Attestations
    tekton.dev/pipelines.minVersion: "0.19"
    tekton.dev/tags: vsa, attestation, cosign
  labels:
    app.kubernetes.io/version: "0.1"

spec:
  description: |
    Attach Verification Summary Attestations (VSAs) to container images.

    This task reads VSA files from trusted artifacts and attaches them as
    signed attestations to container images in the destination registry.

  params:
    - name: SNAPSHOT_FILENAME
      type: string
      description: The filename of the mapped Snapshot (with destination images)

    - name: SOURCE_DATA_ARTIFACT
      type: string
      description: Trusted Artifact containing the Snapshot and VSA files

    - name: VSA_GENERATED
      type: string
      description: Whether VSAs were generated by verify-conforma (true/false)
      default: "false"

    - name: VSA_SIGNING_KEY
      type: string
      description: >-
        Signing key for VSA predicates. Must be a k8s:// or file:// reference.
        Example: k8s://namespace/secret-name
      default: "k8s://slsa-e2e-managed-tenant/release-signing-key"

    - name: VSA_TYPE
      type: string
      description: Attestation predicate type for VSAs
      default: "https://slsa.dev/verification_summary/v1"

    - name: ORAS_OPTIONS
      description: oras options to pass to Trusted Artifacts calls
      type: string
      default: ""

    - name: TRUSTED_ARTIFACTS_DEBUG
      description: Flag to enable debug logging in trusted artifacts
      type: string
      default: ""

    - name: TRUSTED_ARTIFACTS_EXTRACT_DIR
      description: Directory to use to extract trusted artifact archive
      type: string
      default: "/var/workdir/attach-vsa"

    - name: HOMEDIR
      type: string
      description: Value for the HOME environment variable
      default: /tekton/home

    - name: SSL_CERT_DIR
      type: string
      description: SSL cert directory for external registry communication
      default: ""

    - name: CA_TRUST_CONFIGMAP_NAME
      type: string
      description: The name of the ConfigMap to read CA bundle data from
      default: trusted-ca

    - name: CA_TRUST_CONFIG_MAP_KEY
      type: string
      description: The name of the key in the ConfigMap that contains the CA bundle data
      default: ca-bundle.crt

  stepTemplate:
    volumeMounts:
      - mountPath: /var/workdir
        name: workdir
    env:
      - name: "ORAS_OPTIONS"
        value: "$(params.ORAS_OPTIONS)"
      - name: "DEBUG"
        value: "$(params.TRUSTED_ARTIFACTS_DEBUG)"
      - name: HOME
        value: "$(params.HOMEDIR)"
    securityContext:
      runAsUser: 1001

  steps:
    - name: use-trusted-artifact
      args:
        - use
        - $(params.SOURCE_DATA_ARTIFACT)=$(params.TRUSTED_ARTIFACTS_EXTRACT_DIR)
      computeResources: {}
      image: quay.io/redhat-appstudio/build-trusted-artifacts:e02102ede09aa07187cba066ad547a54724e5cf4

    - name: attach-vsa-attestations
      image: gcr.io/projectsigstore/cosign:v2.4.1
      script: |
        #!/busybox/sh
        set -euo pipefail

        if [[ "$(params.VSA_GENERATED)" != "true" ]]; then
          echo "VSA was not generated, skipping attestation attachment"
          exit 0
        fi

        echo "Signing and attaching VSA attestations to destination images..."

        # Extract image references from mapped snapshot
        SNAPSHOT_FILE="$(params.TRUSTED_ARTIFACTS_EXTRACT_DIR)/$(params.SNAPSHOT_FILENAME)"

        if [[ ! -f "$SNAPSHOT_FILE" ]]; then
          echo "ERROR: Snapshot file not found: $SNAPSHOT_FILE"
          exit 1
        fi

        # Get all component images from mapped snapshot (these are destination images)
        IMAGES=$(jq -r '.components[].containerImage' "$SNAPSHOT_FILE")

        if [[ -z "$IMAGES" ]]; then
          echo "ERROR: No images found in mapped snapshot"
          exit 1
        fi

        # VSA predicates should be in /var/workdir/vsa from verify-conforma task
        VSA_DIR="/var/workdir/vsa"

        if [[ ! -d "$VSA_DIR" ]]; then
          echo "ERROR: VSA directory $VSA_DIR not found"
          exit 1
        fi

        # Find VSA predicate files (unsigned JSON)
        VSA_FILES=$(find "$VSA_DIR" -type f -name "*.json")

        if [[ -z "$VSA_FILES" ]]; then
          echo "ERROR: No VSA predicate files found in $VSA_DIR"
          exit 1
        fi

        echo "Found VSA predicate files:"
        echo "$VSA_FILES"
        echo ""

        # Sign and attach VSA to each destination image
        for IMAGE in $IMAGES; do
          echo "Processing image: $IMAGE"

          # Use first VSA file (ec CLI generates one VSA per validation run)
          VSA_PREDICATE=$(echo "$VSA_FILES" | head -1)

          echo "Signing VSA predicate: $VSA_PREDICATE"
          echo "Attaching to image: $IMAGE"

          # Sign the predicate and attach as attestation to the image
          # This creates the DSSE envelope with signature and attaches it
          /ko-app/cosign attest \
            --predicate "$VSA_PREDICATE" \
            --type "$(params.VSA_TYPE)" \
            --key "$(params.VSA_SIGNING_KEY)" \
            "$IMAGE" || {
              echo "WARNING: Failed to sign and attach VSA to $IMAGE"
              continue
            }

          echo "Successfully signed and attached VSA to $IMAGE"
        done

        echo "VSA signing and attachment complete"
      env:
        - name: SSL_CERT_DIR
          value: "/tekton-custom-certs:/etc/ssl/certs:/etc/pki/tls/certs:/system/etc/security/cacerts:$(params.SSL_CERT_DIR)"
      volumeMounts:
        - name: trusted-ca
          mountPath: /etc/pki/tls/certs/ca-custom-bundle.crt
          subPath: ca-bundle.crt
          readOnly: true

  volumes:
    - name: trusted-ca
      configMap:
        name: $(params.CA_TRUST_CONFIGMAP_NAME)
        items:
          - key: $(params.CA_TRUST_CONFIG_MAP_KEY)
            path: ca-bundle.crt
        optional: true
    - name: workdir
      emptyDir: {}
